#!/usr/bin/bash
UUID="$(lsblk -dno UUID /dev/sda2)"

sed -i -e '/^#en_US.UTF-8/s/^#//' -e '/^#ar_EG.UTF-8/s/^#//' /etc/locale.gen
locale-gen
printf '%s\n' 'LANG=en_US.UTF-8' | tee /etc/locale.conf

ln -f -s /usr/share/zoneinfo/Asia/Riyadh /etc/localtime
hwclock -u -w

printf '%s\n%s\n' 'KEYMAP=us' 'FONT=default8x16' | tee /etc/vconsole.conf
printf '%s\n' 'aeiedamo' | tee /etc/hostname

sed -i -e '/^#NoExtract/s/$/ boot\/intel-ucode.img/' -e '/^#NoExtract/s/^#// ' -e '/^#Color/s/^#//' -e '/^#Verbose/s/^#//' -e '/^#\[core-testing\]\|^#\[extra-testing\]/,+1s/^#//' /etc/pacman.conf
printf '%s\n' 'Server = https://fastly.mirror.pkgbuild.com/$repo/os/$arch' | tee /etc/pacman.d/mirrorlist
sed -i -e 's/^MAKEFLAGS.*/MAKEFLAGS="-j8"/' -e '/^#BUILDDIR/s/^#//' -e '/^OPTIONS/s/debug/!&/' /etc/makepkg.conf

sed -i -e '/^HOOKS/s/keymap/plymouth/' /etc/mkinitcpio.conf

pacman -Syu --noconfirm linux linux-headers linux-firmware intel-ucode guestfs-tools plymouth qemu-full qemu-user-static-binfmt snap-pac sof-firmware wireless-regdb alsa-firmware alsa-utils base-devel devtools networkmanager noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra ttf-noto-nerd gdm gnome-control-center virt-manager 7zip alacarte arch-wiki-docs ardour baobab bash-completion bees bluez-cups bluez-utils btrfs-assistant calf cdrtools celluloid cronie crun cups-pdf dconf-editor distrobox dnsmasq easyeffects ebook-tools edk2-shell efibootmgr evolution-ews evolution-spamassassin fastfetch firejail file-roller firefox firewall-applet ghostty gimp github-cli gnome-browser-connector gnome-characters gnome-firmware gnome-keyring gnome-remote-desktop gnome-shell-extension-appindicator gnome-software gnome-themes-extra gnome-tweaks gnome-user-share gparted gst-plugins-bad gst-plugins-ugly gst-plugin-va gvfs-afc gvfs-google gvfs-gphoto2 gvfs-mtp gvfs-nfs gvfs-onedrive hunspell-en_us inetutils intel-media-sdk iwd kdenlive libappindicator libayatana-appindicator libreoffice-fresh linux-tools-meta loupe lsp-plugins-lv2 malcontent man-db mda.lv2 mission-center modemmanager nm-connection-editor net-tools nss-mdns nvme-cli obs-studio onnxruntime-cpu obsidian okular orca pipewire-alsa pipewire-jack podman proton-vpn-gtk-app qalculate-gtk qbittorrent qt6-multimedia-gstreamer radvd rnote rust rygel samba seahorse snapshot swtpm system-config-printer telegram-desktop throttled trash-cli tuned-ppd unrar usb_modeswitch vulkan-intel wl-clipboard yt-dlp zam-plugins-lv2 zed zip zram-generator

bootctl install --variables=no

printf '%s\t%s\n' 'default' 'arch-linux.conf' | tee /boot/loader/loader.conf

printf '%s\t%s\n%s\t%s\n%s\t%s\n%s\t%s%s %s %s %s\n' 'title' 'Arch Linux' 'linux' '/vmlinuz-linux' 'initrd' '/initramfs-linux.img' 'options' 'root=UUID=' "${UUID}" 'rw rootflags=compress=zstd,subvol=/@' 'lsm=landlock,lockdown,yama,integrity,apparmor,bpf' 'quiet splash' | tee /boot/loader/entries/arch-linux.conf

cp /usr/share/edk2-shell/x64/Shell.efi /boot/shellx64.efi

mv /etc/bees/beesd.conf.sample /etc/bees/beesd.conf
sed -i -e "/^UUID/s/=.*$/=${UUID}/" -e '/^# DB_SIZE/s/^# //' /etc/bees/beesd.conf

printf '%s\n' '%wheel ALL=(ALL:ALL) ALL' | tee /etc/sudoers.d/01-wheel

passwd root

useradd -c 'AlaEldin Mohamed' -G audio,disk,kvm,libvirt,log,storage,wheel -m am
passwd am

sed -i -e '/SA/s/^#//' /etc/conf.d/wireless-regdom

printf '%s\n' 'options psmouse synaptics_intertouch=1' | tee /etc/modprobe.d/psmouse.conf

printf '%s\n%s\n%s\n' '[zram0]' 'zram-size=ram' 'compression-algorithm=zstd' | tee /etc/systemd/zram-generator.conf
mkdir -p /etc/systemd/logind.conf.d/
printf '%s\n%s\n%s\n' '[Login]' 'HandleLidSwitch=ignore' 'HandleLidSwitchExternalPower=ignore' | tee /etc/systemd/logind.conf.d/lid.conf

sed -i -e '/^#MulticastDNS/s/yes/no/' -e '/^#MulticastDNS/s/^#//' /etc/systemd/resolved.conf

printf '%s\n' 'ListenAddress aeiedamo.local' | tee /etc/ssh/sshd_config.d/00-local.conf

printf '%s\n' "export EDITOR='vim' VISUAL='vim'" | tee /etc/profile.d/01-editor.sh

printf '%s\n' 'export XDG_CONFIG_HOME="${HOME}/.config" XDG_DATA_HOME="${HOME}/.local/share" XDG_STATE_HOME="${HOME}/.local/state"' | tee /etc/profile.d/02-xdg.sh

printf '%s\n' 'export XDG_DATA_DIRS="${XDG_DATA_DIRS}:/var/lib/flatpak/exports/share:${HOME}/.local/share/flatpak/exports/share"' | tee /etc/profile.d/03-flatpak.sh

printf '%s\n' 'export QT_QPA_PLATFORMTHEME=gtk3' | tee /etc/profile.d/04-qt.sh

sed -i -e '/^hosts/s/resolve \[\!UNAVAIL=return\]/mdns_minimal \[NOTFOUND=return\]/g' /etc/nsswitch.conf

printf '%s\n%s\n' '[main]' 'dns=systemd-resolved' | tee /etc/NetworkManager/conf.d/dns.conf
printf '%s\n%s\n' '[device]' 'wifi.backend=iwd' | tee /etc/NetworkManager/conf.d/wifi_backend.conf

mv /opt/configs/fonts/local.conf /etc/fonts/

sed -i -e '/^PercentageLow/s/=.*$/=10.0/' -e '/^CriticalPowerAction/s/HybridSleep/PowerOff/' /etc/UPower/UPower.conf

printf '%s\n%s\n%s\n' 'user-db:user' 'system-db:gdm' 'file-db:/usr/share/gdm/greeter-dconf-defaults' | tee /etc/dconf/profile/gdm

mkdir -p /etc/dconf/db/gdm.d/
printf '%s\n%s\n' '[org/gnome/desktop/interface]' "font-name='Sans 10'" | tee /etc/dconf/db/gdm.d/01-fonts
printf '%s\n%s\n' '[org/gnome/desktop/interface]' 'show-battery-percentage=true' | tee /etc/dconf/db/gdm.d/02-batterypercentage
printf '%s\n%s\n' '[org/gnome/login-screen]' "logo=''" | tee /etc/dconf/db/gdm.d/03-logo

dconf update

printf '%s\n%s\n' 'pref("general.config.filename", "firefox.cfg");' 'pref("general.config.obscure_value", 0);' | tee /usr/lib/firefox/defaults/pref/autoconfig.js
mv /opt/configs/firefox/firefox.cfg /usr/lib/firefox/

rm -f -r /opt/configs

printf '%s\n' '--cookies-from-browser firefox -f "bv+ba/b" -S "ext" -o "${HOME}/Videos/%(webpage_url_domain)s/%(id)s-%(title)s.%(ext)s"' | tee /etc/yt-dlp.conf

systemctl enable apparmor.service avahi-daemon.service beesd@${UUID}.service bluetooth.service cronie.service cups.service firewalld.service fwupd-refresh.timer gdm.service gnome-remote-desktop.service libvirtd.service ModemManager.service NetworkManager.service sshd.service systemd-boot-update.service systemd-resolved.service systemd-timesyncd.service throttled.service tuned.service tuned-ppd.service virtnetworkd.service virtqemud.service virtstoraged.service
